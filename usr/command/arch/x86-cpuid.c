/* SPDX-License-Identifier: GPL-2.0-or-later */
/*
 * Copyright(c) 2022 Sanpe <sanpeqf@gmail.com>
 */

#include <initcall.h>
#include <kshell.h>
#include <asm/regs.h>

struct cpuid_entry {
    const char *name;
    uint64_t value;
};

#define CPUID_ENTRY(cpuid) \
    {#cpuid, cpuid}

static const struct cpuid_entry cpuid_table[] = {
    CPUID_ENTRY(X86_CPUID_FPU),
    CPUID_ENTRY(X86_CPUID_VME),
    CPUID_ENTRY(X86_CPUID_DE),
    CPUID_ENTRY(X86_CPUID_PSE),
    CPUID_ENTRY(X86_CPUID_TSC),
    CPUID_ENTRY(X86_CPUID_MSR),
    CPUID_ENTRY(X86_CPUID_PAE),
    CPUID_ENTRY(X86_CPUID_MCE),
    CPUID_ENTRY(X86_CPUID_CX8),
    CPUID_ENTRY(X86_CPUID_APIC),
    CPUID_ENTRY(X86_CPUID_SEP),
    CPUID_ENTRY(X86_CPUID_MTRR),
    CPUID_ENTRY(X86_CPUID_PGE),
    CPUID_ENTRY(X86_CPUID_MCA),
    CPUID_ENTRY(X86_CPUID_CMOV),
    CPUID_ENTRY(X86_CPUID_PAT),
    CPUID_ENTRY(X86_CPUID_PSE36),
    CPUID_ENTRY(X86_CPUID_PN),
    CPUID_ENTRY(X86_CPUID_CLFLUSH),
    CPUID_ENTRY(X86_CPUID_DS),
    CPUID_ENTRY(X86_CPUID_ACPI),
    CPUID_ENTRY(X86_CPUID_MMX),
    CPUID_ENTRY(X86_CPUID_FXSR),
    CPUID_ENTRY(X86_CPUID_XMM),
    CPUID_ENTRY(X86_CPUID_XMM2),
    CPUID_ENTRY(X86_CPUID_SELFSNOOP),
    CPUID_ENTRY(X86_CPUID_HT),
    CPUID_ENTRY(X86_CPUID_ACC),
    CPUID_ENTRY(X86_CPUID_IA64),
    CPUID_ENTRY(X86_CPUID_PBE),
    CPUID_ENTRY(X86_CPUID_SYSCALL),
    CPUID_ENTRY(X86_CPUID_MP),
    CPUID_ENTRY(X86_CPUID_NX),
    CPUID_ENTRY(X86_CPUID_MMXEXT),
    CPUID_ENTRY(X86_CPUID_FXSR_OPT),
    CPUID_ENTRY(X86_CPUID_GBPAGES),
    CPUID_ENTRY(X86_CPUID_RDTSCP),
    CPUID_ENTRY(X86_CPUID_LM),
    CPUID_ENTRY(X86_CPUID_3DNOWEXT),
    CPUID_ENTRY(X86_CPUID_3DNOW),
    CPUID_ENTRY(X86_CPUID_RECOVERY),
    CPUID_ENTRY(X86_CPUID_LONGRUN),
    CPUID_ENTRY(X86_CPUID_LRTI),
    CPUID_ENTRY(X86_CPUID_CXMMX),
    CPUID_ENTRY(X86_CPUID_K6_MTRR),
    CPUID_ENTRY(X86_CPUID_CYRIX_ARR),
    CPUID_ENTRY(X86_CPUID_CENTAUR_MCR),
    CPUID_ENTRY(X86_CPUID_K8),
    CPUID_ENTRY(X86_CPUID_P3),
    CPUID_ENTRY(X86_CPUID_P4),
    CPUID_ENTRY(X86_CPUID_CONSTANT_TSC),
    CPUID_ENTRY(X86_CPUID_UP),
    CPUID_ENTRY(X86_CPUID_ART),
    CPUID_ENTRY(X86_CPUID_ARCH_PERFMON),
    CPUID_ENTRY(X86_CPUID_PEBS),
    CPUID_ENTRY(X86_CPUID_BTS),
    CPUID_ENTRY(X86_CPUID_SYSCALL32),
    CPUID_ENTRY(X86_CPUID_SYSENTER32),
    CPUID_ENTRY(X86_CPUID_REP_GOOD),
    CPUID_ENTRY(X86_CPUID_LFENCE_RDTSC),
    CPUID_ENTRY(X86_CPUID_ACC_POWER),
    CPUID_ENTRY(X86_CPUID_NOPL),
    CPUID_ENTRY(X86_CPUID_ALWAYS),
    CPUID_ENTRY(X86_CPUID_XTOPOLOGY),
    CPUID_ENTRY(X86_CPUID_TSC_RELIABLE),
    CPUID_ENTRY(X86_CPUID_NONSTOP_TSC),
    CPUID_ENTRY(X86_CPUID_CPUID),
    CPUID_ENTRY(X86_CPUID_EXTD_APICID),
    CPUID_ENTRY(X86_CPUID_AMD_DCM),
    CPUID_ENTRY(X86_CPUID_APERFMPERF),
    CPUID_ENTRY(X86_CPUID_RAPL),
    CPUID_ENTRY(X86_CPUID_NONSTOP_TSC_S3),
    CPUID_ENTRY(X86_CPUID_TSC_KNOWN_FREQ),
    CPUID_ENTRY(X86_CPUID_XMM3),
    CPUID_ENTRY(X86_CPUID_PCLMULQDQ),
    CPUID_ENTRY(X86_CPUID_DTES64),
    CPUID_ENTRY(X86_CPUID_MWAIT),
    CPUID_ENTRY(X86_CPUID_DSCPL),
    CPUID_ENTRY(X86_CPUID_VMX),
    CPUID_ENTRY(X86_CPUID_SMX),
    CPUID_ENTRY(X86_CPUID_EST),
    CPUID_ENTRY(X86_CPUID_TM2),
    CPUID_ENTRY(X86_CPUID_SSSE3),
    CPUID_ENTRY(X86_CPUID_CID),
    CPUID_ENTRY(X86_CPUID_SDBG),
    CPUID_ENTRY(X86_CPUID_FMA),
    CPUID_ENTRY(X86_CPUID_CX16),
    CPUID_ENTRY(X86_CPUID_XTPR),
    CPUID_ENTRY(X86_CPUID_PDCM),
    CPUID_ENTRY(X86_CPUID_PCID),
    CPUID_ENTRY(X86_CPUID_DCA),
    CPUID_ENTRY(X86_CPUID_XMM4_1),
    CPUID_ENTRY(X86_CPUID_XMM4_2),
    CPUID_ENTRY(X86_CPUID_X2APIC),
    CPUID_ENTRY(X86_CPUID_MOVBE),
    CPUID_ENTRY(X86_CPUID_POPCNT),
    CPUID_ENTRY(X86_CPUID_TSC_DEADLINE_TIMER),
    CPUID_ENTRY(X86_CPUID_AES),
    CPUID_ENTRY(X86_CPUID_XSAVE),
    CPUID_ENTRY(X86_CPUID_OSXSAVE),
    CPUID_ENTRY(X86_CPUID_AVX),
    CPUID_ENTRY(X86_CPUID_F16C),
    CPUID_ENTRY(X86_CPUID_RDRAND),
    CPUID_ENTRY(X86_CPUID_HYPERVISOR),
    CPUID_ENTRY(X86_CPUID_XSTORE),
    CPUID_ENTRY(X86_CPUID_XSTORE_EN),
    CPUID_ENTRY(X86_CPUID_XCRYPT),
    CPUID_ENTRY(X86_CPUID_XCRYPT_EN),
    CPUID_ENTRY(X86_CPUID_ACE2),
    CPUID_ENTRY(X86_CPUID_ACE2_EN),
    CPUID_ENTRY(X86_CPUID_PHE),
    CPUID_ENTRY(X86_CPUID_PHE_EN),
    CPUID_ENTRY(X86_CPUID_PMM),
    CPUID_ENTRY(X86_CPUID_PMM_EN),
    CPUID_ENTRY(X86_CPUID_LAHF_LM),
    CPUID_ENTRY(X86_CPUID_CMP_LEGACY),
    CPUID_ENTRY(X86_CPUID_SVM),
    CPUID_ENTRY(X86_CPUID_EXTAPIC),
    CPUID_ENTRY(X86_CPUID_CR8_LEGACY),
    CPUID_ENTRY(X86_CPUID_ABM),
    CPUID_ENTRY(X86_CPUID_SSE4A),
    CPUID_ENTRY(X86_CPUID_MISALIGNSSE),
    CPUID_ENTRY(X86_CPUID_3DNOWPREFETCH),
    CPUID_ENTRY(X86_CPUID_OSVW),
    CPUID_ENTRY(X86_CPUID_IBS),
    CPUID_ENTRY(X86_CPUID_XOP),
    CPUID_ENTRY(X86_CPUID_SKINIT),
    CPUID_ENTRY(X86_CPUID_WDT),
    CPUID_ENTRY(X86_CPUID_LWP),
    CPUID_ENTRY(X86_CPUID_FMA4),
    CPUID_ENTRY(X86_CPUID_TCE),
    CPUID_ENTRY(X86_CPUID_NODEID_MSR),
    CPUID_ENTRY(X86_CPUID_TBM),
    CPUID_ENTRY(X86_CPUID_TOPOEXT),
    CPUID_ENTRY(X86_CPUID_PERFCTR_CORE),
    CPUID_ENTRY(X86_CPUID_PERFCTR_NB),
    CPUID_ENTRY(X86_CPUID_BPEXT),
    CPUID_ENTRY(X86_CPUID_PTSC),
    CPUID_ENTRY(X86_CPUID_PERFCTR_LLC),
    CPUID_ENTRY(X86_CPUID_MWAITX),
    CPUID_ENTRY(X86_CPUID_RING3MWAIT),
    CPUID_ENTRY(X86_CPUID_CPUID_FAULT),
    CPUID_ENTRY(X86_CPUID_CPB),
    CPUID_ENTRY(X86_CPUID_EPB),
    CPUID_ENTRY(X86_CPUID_CAT_L3),
    CPUID_ENTRY(X86_CPUID_CAT_L2),
    CPUID_ENTRY(X86_CPUID_CDP_L3),
    CPUID_ENTRY(X86_CPUID_INVPCID_SINGLE),
    CPUID_ENTRY(X86_CPUID_HW_PSTATE),
    CPUID_ENTRY(X86_CPUID_PROC_FEEDBACK),
    CPUID_ENTRY(X86_CPUID_PTI),
    CPUID_ENTRY(X86_CPUID_RETPOLINE),
    CPUID_ENTRY(X86_CPUID_RETPOLINE_AMD),
    CPUID_ENTRY(X86_CPUID_INTEL_PPIN),
    CPUID_ENTRY(X86_CPUID_CDP_L2),
    CPUID_ENTRY(X86_CPUID_MSR_SPEC_CTRL),
    CPUID_ENTRY(X86_CPUID_SSBD),
    CPUID_ENTRY(X86_CPUID_MBA),
    CPUID_ENTRY(X86_CPUID_RSB_CTXSW),
    CPUID_ENTRY(X86_CPUID_USE_IBPB),
    CPUID_ENTRY(X86_CPUID_USE_IBRS_FW),
    CPUID_ENTRY(X86_CPUID_SPEC_STORE_BYPASS_DISABLE),
    CPUID_ENTRY(X86_CPUID_LS_CFG_SSBD),
    CPUID_ENTRY(X86_CPUID_IBRS),
    CPUID_ENTRY(X86_CPUID_IBPB),
    CPUID_ENTRY(X86_CPUID_STIBP),
    CPUID_ENTRY(X86_CPUID_ZEN),
    CPUID_ENTRY(X86_CPUID_L1TF_PTEINV),
    CPUID_ENTRY(X86_CPUID_IBRS_ENHANCED),
    CPUID_ENTRY(X86_CPUID_MSR_IA32_FEAT_CTL),
    CPUID_ENTRY(X86_CPUID_TPR_SHADOW),
    CPUID_ENTRY(X86_CPUID_VNMI),
    CPUID_ENTRY(X86_CPUID_FLEXPRIORITY),
    CPUID_ENTRY(X86_CPUID_EPT),
    CPUID_ENTRY(X86_CPUID_VPID),
    CPUID_ENTRY(X86_CPUID_VMMCALL),
    CPUID_ENTRY(X86_CPUID_XENPV),
    CPUID_ENTRY(X86_CPUID_EPT_AD),
    CPUID_ENTRY(X86_CPUID_VMCALL),
    CPUID_ENTRY(X86_CPUID_VMW_VMMCALL),
    CPUID_ENTRY(X86_CPUID_PVUNLOCK),
    CPUID_ENTRY(X86_CPUID_VCPUPREEMPT),
    CPUID_ENTRY(X86_CPUID_FSGSBASE),
    CPUID_ENTRY(X86_CPUID_TSC_ADJUST),
    CPUID_ENTRY(X86_CPUID_SGX),
    CPUID_ENTRY(X86_CPUID_BMI1),
    CPUID_ENTRY(X86_CPUID_HLE),
    CPUID_ENTRY(X86_CPUID_AVX2),
    CPUID_ENTRY(X86_CPUID_FDP_EXCPTN_ONLY),
    CPUID_ENTRY(X86_CPUID_SMEP),
    CPUID_ENTRY(X86_CPUID_BMI2),
    CPUID_ENTRY(X86_CPUID_ERMS),
    CPUID_ENTRY(X86_CPUID_INVPCID),
    CPUID_ENTRY(X86_CPUID_RTM),
    CPUID_ENTRY(X86_CPUID_CQM),
    CPUID_ENTRY(X86_CPUID_ZERO_FCS_FDS),
    CPUID_ENTRY(X86_CPUID_MPX),
    CPUID_ENTRY(X86_CPUID_RDT_A),
    CPUID_ENTRY(X86_CPUID_AVX512F),
    CPUID_ENTRY(X86_CPUID_AVX512DQ),
    CPUID_ENTRY(X86_CPUID_RDSEED),
    CPUID_ENTRY(X86_CPUID_ADX),
    CPUID_ENTRY(X86_CPUID_SMAP),
    CPUID_ENTRY(X86_CPUID_AVX512IFMA),
    CPUID_ENTRY(X86_CPUID_CLFLUSHOPT),
    CPUID_ENTRY(X86_CPUID_CLWB),
    CPUID_ENTRY(X86_CPUID_INTEL_PT),
    CPUID_ENTRY(X86_CPUID_AVX512PF),
    CPUID_ENTRY(X86_CPUID_AVX512ER),
    CPUID_ENTRY(X86_CPUID_AVX512CD),
    CPUID_ENTRY(X86_CPUID_SHA_NI),
    CPUID_ENTRY(X86_CPUID_AVX512BW),
    CPUID_ENTRY(X86_CPUID_AVX512VL),
    CPUID_ENTRY(X86_CPUID_XSAVEOPT),
    CPUID_ENTRY(X86_CPUID_XSAVEC),
    CPUID_ENTRY(X86_CPUID_XGETBV1),
    CPUID_ENTRY(X86_CPUID_XSAVES),
    CPUID_ENTRY(X86_CPUID_XFD),
    CPUID_ENTRY(X86_CPUID_CQM_LLC),
    CPUID_ENTRY(X86_CPUID_CQM_OCCUP_LLC),
    CPUID_ENTRY(X86_CPUID_CQM_MBM_TOTAL),
    CPUID_ENTRY(X86_CPUID_CQM_MBM_LOCAL),
    CPUID_ENTRY(X86_CPUID_FENCE_SWAPGS_USER),
    CPUID_ENTRY(X86_CPUID_FENCE_SWAPGS_KERNEL),
    CPUID_ENTRY(X86_CPUID_SPLIT_LOCK_DETECT),
    CPUID_ENTRY(X86_CPUID_PER_THREAD_MBA),
    CPUID_ENTRY(X86_CPUID_SGX1),
    CPUID_ENTRY(X86_CPUID_SGX2),
    CPUID_ENTRY(X86_CPUID_AVX_VNNI),
    CPUID_ENTRY(X86_CPUID_AVX512_BF16),
    CPUID_ENTRY(X86_CPUID_CLZERO),
    CPUID_ENTRY(X86_CPUID_IRPERF),
    CPUID_ENTRY(X86_CPUID_XSAVEERPTR),
    CPUID_ENTRY(X86_CPUID_RDPRU),
    CPUID_ENTRY(X86_CPUID_WBNOINVD),
    CPUID_ENTRY(X86_CPUID_AMD_IBPB),
    CPUID_ENTRY(X86_CPUID_AMD_IBRS),
    CPUID_ENTRY(X86_CPUID_AMD_STIBP),
    CPUID_ENTRY(X86_CPUID_AMD_STIBP_ALWAYS_ON),
    CPUID_ENTRY(X86_CPUID_AMD_PPIN),
    CPUID_ENTRY(X86_CPUID_AMD_SSBD),
    CPUID_ENTRY(X86_CPUID_VIRT_SSBD),
    CPUID_ENTRY(X86_CPUID_AMD_SSB_NO),
    CPUID_ENTRY(X86_CPUID_DTHERM),
    CPUID_ENTRY(X86_CPUID_IDA),
    CPUID_ENTRY(X86_CPUID_ARAT),
    CPUID_ENTRY(X86_CPUID_PLN),
    CPUID_ENTRY(X86_CPUID_PTS),
    CPUID_ENTRY(X86_CPUID_HWP),
    CPUID_ENTRY(X86_CPUID_HWP_NOTIFY),
    CPUID_ENTRY(X86_CPUID_HWP_ACT_WINDOW),
    CPUID_ENTRY(X86_CPUID_HWP_EPP),
    CPUID_ENTRY(X86_CPUID_HWP_PKG_REQ),
    CPUID_ENTRY(X86_CPUID_NPT),
    CPUID_ENTRY(X86_CPUID_LBRV),
    CPUID_ENTRY(X86_CPUID_SVML),
    CPUID_ENTRY(X86_CPUID_NRIPS),
    CPUID_ENTRY(X86_CPUID_TSCRATEMSR),
    CPUID_ENTRY(X86_CPUID_VMCBCLEAN),
    CPUID_ENTRY(X86_CPUID_FLUSHBYASID),
    CPUID_ENTRY(X86_CPUID_DECODEASSISTS),
    CPUID_ENTRY(X86_CPUID_PAUSEFILTER),
    CPUID_ENTRY(X86_CPUID_PFTHRESHOLD),
    CPUID_ENTRY(X86_CPUID_AVIC),
    CPUID_ENTRY(X86_CPUID_V_VMSAVE_VMLOAD),
    CPUID_ENTRY(X86_CPUID_VGIF),
    CPUID_ENTRY(X86_CPUID_V_SPEC_CTRL),
    CPUID_ENTRY(X86_CPUID_SVME_ADDR_CHK),
    CPUID_ENTRY(X86_CPUID_AVX512VBMI),
    CPUID_ENTRY(X86_CPUID_UMIP),
    CPUID_ENTRY(X86_CPUID_PKU),
    CPUID_ENTRY(X86_CPUID_OSPKE),
    CPUID_ENTRY(X86_CPUID_WAITPKG),
    CPUID_ENTRY(X86_CPUID_AVX512_VBMI2),
    CPUID_ENTRY(X86_CPUID_GFNI),
    CPUID_ENTRY(X86_CPUID_VAES),
    CPUID_ENTRY(X86_CPUID_VPCLMULQDQ),
    CPUID_ENTRY(X86_CPUID_AVX512_VNNI),
    CPUID_ENTRY(X86_CPUID_AVX512_BITALG),
    CPUID_ENTRY(X86_CPUID_TME),
    CPUID_ENTRY(X86_CPUID_AVX512_VPOPCNTDQ),
    CPUID_ENTRY(X86_CPUID_LA57),
    CPUID_ENTRY(X86_CPUID_RDPID),
    CPUID_ENTRY(X86_CPUID_BUS_LOCK_DETECT),
    CPUID_ENTRY(X86_CPUID_CLDEMOTE),
    CPUID_ENTRY(X86_CPUID_MOVDIRI),
    CPUID_ENTRY(X86_CPUID_MOVDIR64B),
    CPUID_ENTRY(X86_CPUID_ENQCMD),
    CPUID_ENTRY(X86_CPUID_SGX_LC),
    CPUID_ENTRY(X86_CPUID_OVERFLOW_RECOV),
    CPUID_ENTRY(X86_CPUID_SUCCOR),
    CPUID_ENTRY(X86_CPUID_SMCA),
    CPUID_ENTRY(X86_CPUID_AVX512_4VNNIW),
    CPUID_ENTRY(X86_CPUID_AVX512_4FMAPS),
    CPUID_ENTRY(X86_CPUID_FSRM),
    CPUID_ENTRY(X86_CPUID_AVX512_VP2INTERSECT),
    CPUID_ENTRY(X86_CPUID_SRBDS_CTRL),
    CPUID_ENTRY(X86_CPUID_MD_CLEAR),
    CPUID_ENTRY(X86_CPUID_RTM_ALWAYS_ABORT),
    CPUID_ENTRY(X86_CPUID_TSX_FORCE_ABORT),
    CPUID_ENTRY(X86_CPUID_SERIALIZE),
    CPUID_ENTRY(X86_CPUID_HYBRID_CPU),
    CPUID_ENTRY(X86_CPUID_TSXLDTRK),
    CPUID_ENTRY(X86_CPUID_PCONFIG),
    CPUID_ENTRY(X86_CPUID_ARCH_LBR),
    CPUID_ENTRY(X86_CPUID_AMX_BF16),
    CPUID_ENTRY(X86_CPUID_AVX512_FP16),
    CPUID_ENTRY(X86_CPUID_AMX_TILE),
    CPUID_ENTRY(X86_CPUID_AMX_INT8),
    CPUID_ENTRY(X86_CPUID_SPEC_CTRL),
    CPUID_ENTRY(X86_CPUID_INTEL_STIBP),
    CPUID_ENTRY(X86_CPUID_FLUSH_L1D),
    CPUID_ENTRY(X86_CPUID_ARCH_CAPABILITIES),
    CPUID_ENTRY(X86_CPUID_CORE_CAPABILITIES),
    CPUID_ENTRY(X86_CPUID_SPEC_CTRL_SSBD),
    CPUID_ENTRY(X86_CPUID_SME),
    CPUID_ENTRY(X86_CPUID_SEV),
    CPUID_ENTRY(X86_CPUID_VM_PAGE_FLUSH),
    CPUID_ENTRY(X86_CPUID_SEV_ES),
    CPUID_ENTRY(X86_CPUID_SME_COHERENT),
};

static const char *reg_name[] = {
    "eax", "ebx", "ecx", "edx"
};

static state cpuid_main(struct kshell_context *ctx, int argc, char *argv[])
{
    const struct cpuid_entry *entry;
    unsigned int count;

    for (count = 0; count < ARRAY_SIZE(cpuid_table); ++count) {
        entry = cpuid_table + count;
        if (cpuid_support(entry->value))
            kshell_printf(ctx, "opcode: %#08llx reg: %-3s bit: %2lld name: %s\n",
                X86_CPUID_OP_GET(entry->value), reg_name[X86_CPUID_REG_GET(entry->value)],
                X86_CPUID_BIT_GET(entry->value), entry->name);
    }

    return -ENOERR;
}

static struct kshell_command cpuid_cmd = {
    .name = "cpuid",
    .desc = "show processor cpuid",
    .exec = cpuid_main,
};

static state cpuid_init(void)
{
    return kshell_register(&cpuid_cmd);
}
kshell_initcall(cpuid_init);
